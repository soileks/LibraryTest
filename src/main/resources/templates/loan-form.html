
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Loan</title>
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
<div class="container">
    <div class="form-container">
        <h1>📝 New Loan</h1>

        <div class="navigation">
            <a th:href="@{/loans}" class="btn btn-secondary">← Back to Loans</a>
        </div>

        <!-- Секция выбора клиента -->
        <div class="selection-section">
            <h3>👤 Step 1: Select Client</h3>

            <!-- Выбранный клиент -->
            <div th:if="${selectedClient != null}" class="selected-item">
                <div>
                    <strong th:text="${selectedClient.fullName}"></strong>
                    <div th:text="'Birth date: ' + ${#temporals.format(selectedClient.birthDate, 'yyyy-MM-dd')}"></div>
                </div>
                <div class="selection-actions">
                    <a th:href="@{/loans/new(selectedBookId=${selectedBookId})}"
                       class="btn btn-secondary btn-sm">Change Client</a>
                </div>
            </div>

            <!-- Поиск клиента -->
            <div th:unless="${selectedClient != null}">
                <div class="search-box">
                    <form th:action="@{/loans/new}" method="get" class="form-inline">
                        <input type="hidden" name="selectedBookId" th:value="${selectedBookId}">
                        <input type="text" name="clientQuery" th:value="${clientQuery}"
                               placeholder="Search client by name..." class="form-control">
                        <button type="submit" class="btn btn-primary">🔍 Search Client</button>
                    </form>
                </div>

                <!-- Результаты поиска клиентов -->
                <div th:if="${clientQuery != null and !clientQuery.isEmpty()}" class="search-results">
                    <h4>Search Results:</h4>
                    <div th:if="${clients != null and !clients.empty}">
                        <div th:each="client : ${clients}" class="result-item">
                            <a th:href="@{/loans/new(selectedClientId=${client.id}, selectedBookId=${selectedBookId})}"
                               style="text-decoration: none; color: inherit; display: block;">
                                <span th:text="${client.fullName + ' (' + #temporals.format(client.birthDate, 'yyyy-MM-dd') + ')'}"></span>
                            </a>
                        </div>
                    </div>
                    <div th:if="${clients != null and clients.empty}" class="alert alert-info">
                        📝 No clients found for "<strong th:text="${clientQuery}"></strong>"
                    </div>
                </div>
            </div>
        </div>

        <!-- Секция выбора книги -->
        <div class="selection-section">
            <h3>📚 Step 2: Select Book</h3>

            <!-- Выбранная книга -->
            <div th:if="${selectedBook != null}" class="selected-item">
                <div>
                    <strong th:text="${selectedBook.title}"></strong>
                    <div th:text="'by ' + ${selectedBook.author} + ' (ISBN: ' + ${selectedBook.isbn} + ')'"></div>
                </div>
                <div class="selection-actions">
                    <a th:href="@{/loans/new(selectedClientId=${selectedClientId})}"
                       class="btn btn-secondary btn-sm">Change Book</a>
                </div>
            </div>

            <!-- Поиск книги -->
            <div th:unless="${selectedBook != null}">
                <div class="search-box">
                    <form th:action="@{/loans/new}" method="get" class="form-inline">
                        <input type="hidden" name="selectedClientId" th:value="${selectedClientId}">
                        <input type="text" name="bookQuery" th:value="${bookQuery}"
                               placeholder="Search book by title, author or ISBN..." class="form-control">
                        <button type="submit" class="btn btn-primary">🔍 Search Book</button>
                    </form>
                </div>

                <!-- Результаты поиска книг -->
                <div th:if="${bookQuery != null and !bookQuery.isEmpty()}" class="search-results">
                    <h4>Search Results:</h4>
                    <div th:if="${books != null and !books.empty}">
                        <div th:each="book : ${books}" class="result-item">
                            <a th:href="@{/loans/new(selectedBookId=${book.id}, selectedClientId=${selectedClientId})}"
                               style="text-decoration: none; color: inherit; display: block;">
                                <span th:text="${book.title + ' by ' + book.author + ' (' + book.isbn + ')'}"></span>
                            </a>
                        </div>
                    </div>
                    <div th:if="${books != null and books.empty}" class="alert alert-info">
                        📝 No books found for "<strong th:text="${bookQuery}"></strong>"
                    </div>
                </div>
            </div>
        </div>

        <!-- Форма создания займа -->
        <div th:if="${selectedClient != null and selectedBook != null}" class="selection-section">
            <h3>📅 Step 3: Create Loan</h3>

            <form th:action="@{/loans/save}" method="post" class="form">
                <input type="hidden" name="selectedClientId" th:value="${selectedClient.id}">
                <input type="hidden" name="selectedBookId" th:value="${selectedBook.id}">

                <div class="form-group">
                    <label for="loanDate">Loan Date:</label>
                    <input type="date" id="loanDate" name="loanDate"
                           th:value="${#temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}"
                           required class="form-control">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">✅ Create Loan</button>
                    <a th:href="@{/loans/new}" class="btn btn-secondary">🔄 Start Over</a>
                    <a th:href="@{/loans}" class="btn btn-secondary">❌ Cancel</a>
                </div>
            </form>
        </div>

        <div th:unless="${selectedClient != null and selectedBook != null}" class="alert alert-info">
            ⚠️ Please complete both steps above to create a loan
        </div>
    </div>
</div>
</body>
</html>
