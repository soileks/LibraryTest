<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Loan</title>
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
<div class="container">
    <div class="form-container">
        <h1>üìù New Loan</h1>

        <div class="navigation">
            <a th:href="@{/loans}" class="btn btn-secondary">‚Üê Back to Loans</a>
        </div>

        <div class="selection-section">
            <h3>üë§ Step 1: Select Client</h3>

            <div th:if="${selectedClient != null}" class="selected-item">
                <div>
                    <strong th:text="${selectedClient.fullName}"></strong>
                    <div th:text="'Birth date: ' + ${#temporals.format(selectedClient.birthDate, 'yyyy-MM-dd')}"></div>
                </div>
<!--    –ü–æ –∫–Ω–æ–ø–∫–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—á–∏—â–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞, –æ—Å—Ç–∞–≤–ª—è—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–Ω–∏–≥–∏-->
                <div class="selection-actions">
                    <a th:href="@{/loans/new(selectedBookId=${selectedBookId}, bookQuery=${bookQuery}, bookSearchType=${bookSearchType})}"
                       class="btn btn-secondary btn-sm">Change Client</a>
                </div>
            </div>
<!--            –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω, —Ç–æ –ø–æ–∏—Å–∫-->
            <div th:unless="${selectedClient != null}">
                <div class="search-box">
                    <form th:action="@{/loans/new}" method="get" class="form-inline">
                        <input type="hidden" name="selectedBookId" th:value="${selectedBookId}">
                        <input type="hidden" name="bookQuery" th:value="${bookQuery}">
                        <input type="hidden" name="bookSearchType" th:value="${bookSearchType}">

                        <select name="clientSearchType" class="form-control">
                            <option value="all" th:selected="${clientSearchType == 'all'}">All Fields</option>
                            <option value="name" th:selected="${clientSearchType == 'name'}">By Name</option>
                            <option value="birthDate" th:selected="${clientSearchType == 'birthDate'}">By Birth Date</option>
                        </select>

                        <input type="text" name="clientQuery" th:value="${clientQuery}"
                               placeholder="Search client..." class="form-control">
                        <button type="submit" class="btn btn-primary">üîç Search Client</button>
                    </form>
                </div>

                <div th:if="${!clientQuery.isEmpty()}" class="search-results">
                    <h4>Search Results:</h4>
                    <div th:if="${clients != null and !clients.isEmpty()}">
                        <div th:each="client : ${clients}" class="result-item">
                            <a th:href="@{/loans/new(selectedClientId=${client.id}, selectedBookId=${selectedBookId}, bookQuery=${bookQuery}, bookSearchType=${bookSearchType}, clientQuery=${clientQuery}, clientSearchType=${clientSearchType})}"
                               style="text-decoration: none; color: inherit; display: block;">
                                <span th:text="${client.fullName + ' (' + #temporals.format(client.birthDate, 'yyyy-MM-dd') + ')'}"></span>
                            </a>
                        </div>
                    </div>
                    <div th:if="${clients != null and clients.isEmpty()}" class="alert alert-info">
                        üìù No clients found for "<strong th:text="${clientQuery}"></strong>"
                    </div>
                </div>
            </div>
        </div>

        <div class="selection-section">
            <h3>üìö Step 2: Select Book</h3>

            <div th:if="${selectedBook != null}" class="selected-item">
                <div>
                    <strong th:text="${selectedBook.title}"></strong>
                    <div th:text="'by ' + ${selectedBook.author} + ' (ISBN: ' + ${selectedBook.isbn} + ')'"></div>
                </div>
                <div class="selection-actions">
                    <a th:href="@{/loans/new(selectedClientId=${selectedClientId}, clientQuery=${clientQuery}, clientSearchType=${clientSearchType})}"
                       class="btn btn-secondary btn-sm">Change Book</a>
                </div>
            </div>

            <div th:unless="${selectedBook != null}">
                <div class="search-box">
                    <form th:action="@{/loans/new}" method="get" class="form-inline">
                        <input type="hidden" name="selectedClientId" th:value="${selectedClientId}">
                        <input type="hidden" name="clientQuery" th:value="${clientQuery}">
                        <input type="hidden" name="clientSearchType" th:value="${clientSearchType}">

                        <select name="bookSearchType" class="form-control">
                            <option value="all" th:selected="${bookSearchType == 'all'}">All Fields</option>
                            <option value="title" th:selected="${bookSearchType == 'title'}">By Title</option>
                            <option value="author" th:selected="${bookSearchType == 'author'}">By Author</option>
                            <option value="isbn" th:selected="${bookSearchType == 'isbn'}">By ISBN</option>
                        </select>

                        <input type="text" name="bookQuery" th:value="${bookQuery}"
                               placeholder="Search book..." class="form-control">
                        <button type="submit" class="btn btn-primary">üîç Search Book</button>
                    </form>
                </div>

                <div th:if="${!bookQuery.isEmpty()}" class="search-results">
                    <h4>Search Results:</h4>
                    <div th:if="${books != null and !books.isEmpty()}">
                        <div th:each="book : ${books}" class="result-item">
                            <a th:href="@{/loans/new(selectedBookId=${book.id}, selectedClientId=${selectedClientId}, clientQuery=${clientQuery}, clientSearchType=${clientSearchType}, bookQuery=${bookQuery}, bookSearchType=${bookSearchType})}"
                               style="text-decoration: none; color: inherit; display: block;">
                                <span th:text="${book.title + ' by ' + book.author + ' (' + book.isbn + ')'}"></span>
                            </a>
                        </div>
                    </div>
                    <div th:if="${books != null and books.isEmpty()}" class="alert alert-info">
                        üìù No books found for "<strong th:text="${bookQuery}"></strong>"
                    </div>
                </div>
            </div>
        </div>

        <div th:if="${selectedClient != null and selectedBook != null}" class="selection-section">
            <h3>üìÖ Step 3: Create Loan</h3>

            <form th:action="@{/loans/save}" method="post" class="form">
                <input type="hidden" name="selectedClientId" th:value="${selectedClient.id}">
                <input type="hidden" name="selectedBookId" th:value="${selectedBook.id}">

                <div class="form-group">
                    <label for="loanDate">Loan Date:</label>
                    <input type="date" id="loanDate" name="loanDate"
                           th:value="${#temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}"
                           required class="form-control">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">‚úÖ Create Loan</button>
                    <a th:href="@{/loans/new}" class="btn btn-secondary">üîÑ Start Over</a>
                    <a th:href="@{/loans}" class="btn btn-secondary">‚ùå Cancel</a>
                </div>
            </form>
        </div>

        <div th:unless="${selectedClient != null and selectedBook != null}" class="alert alert-info">
            ‚ö†Ô∏è Please complete both steps above to create a loan
        </div>
    </div>
</div>
</body>
</html>